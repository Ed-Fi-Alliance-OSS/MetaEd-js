{{#if useLicenseHeader}}
{{#if triggers}}
-- SPDX-License-Identifier: Apache-2.0
-- Licensed to the Ed-Fi Alliance under one or more agreements.
-- The Ed-Fi Alliance licenses this file to you under the Apache License, Version 2.0.
-- See the LICENSE and NOTICES files in the project root for more information.

{{/if}}
{{/if}}
{{#triggers}}
CREATE FUNCTION {{{triggerSchema}}}.{{{triggerName}}}()
    RETURNS trigger AS
$BODY$
BEGIN
    INSERT INTO {{{deleteTrackingTableSchema}}}.{{{deleteTrackingTableName}}}({{#primaryKeyColumnNames}}{{{this}}}{{#unless @last}}, {{/unless}}{{/primaryKeyColumnNames}}, Id, ChangeVersion)
{{#if targetTableIsSubclass}}
    SELECT {{#primaryKeyColumnNames}}OLD.{{{this}}}{{#unless @last}}, {{/unless}}{{/primaryKeyColumnNames}}, Id, nextval('changes.ChangeVersionSequence')
    FROM {{#foreignKeyToSuperclass}}{{{foreignTableSchema}}}.{{{foreignTable.data.edfiOdsPostgresql.tableName}}} WHERE {{#data.edfiOdsChangeQuery.columnNames}}{{{foreignTableColumnName}}} = OLD.{{{parentTableColumnName}}}{{#unless @last}} AND {{/unless}}{{/data.edfiOdsChangeQuery.columnNames}}{{/foreignKeyToSuperclass}};
{{else}}
    VALUES ({{#primaryKeyColumnNames}}OLD.{{{this}}}{{#unless @last}}, {{/unless}}{{/primaryKeyColumnNames}}, OLD.Id, nextval('changes.ChangeVersionSequence'));
{{/if}}
    RETURN NULL;
END;
$BODY$ LANGUAGE plpgsql;

CREATE TRIGGER TrackDeletes AFTER DELETE ON {{{targetTableSchema}}}.{{{targetTableName}}} 
    FOR EACH ROW EXECUTE PROCEDURE {{{triggerSchema}}}.{{{triggerName}}}();

{{/triggers}}