<!DOCTYPE html>
<html>

<head>
    <title>Ed-Fi Unified Data Model Handbook</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/infima@0.2.0-alpha.45/dist/css/default/default.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
        integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
        crossorigin="anonymous" referrerpolicy="no-referrer">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github.min.css"
        integrity="sha512-0aPQyyeZrWj9sCA46UlmWgKOP0mUipLQ6OZXu8l4IcAmD2u31EPEy9VcIMvl7SoAaKe8bLXZhYoMaE/in+gcgA=="
        crossorigin="anonymous" referrerpolicy="no-referrer">

    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.15.0/cdn.min.js"
        integrity="sha512-4M615JhFufNLsrK5+qpW7oZJ8ooDJlzcUqd/+LVic8e9+0JuoO0KLnIf0NGg3e3tvFxRRdngx1VLtiOwPtYM4A=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"
        integrity="sha512-EBLzUL8XLl+va/zAsmXwS7Z2B1F9HUHkZwyS/VKwh3S7T/U0nF4BaU29EP/ZSf6zgiIxYAnKLu6bJ8dqpmX5uw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript">
        // Register custom EdFi SQL language for Highlight.js
        hljs.registerLanguage("edfisql", function (e) {
            return {
                case_insensitive: true,
                illegal: /[<> {}*#]/,
                contains: [{
                    beginKeywords: "create",
                    end: /;/,
                    endsWithParent: true,
                    lexemes: /[\w\.]+/,
                    keywords: {
                        keyword: "create table primary key constraint",
                        literal: "true false not null",
                        built_in: "int bigint short bit float numeric date datetime nvarchar varchar char uniqueidentifier"
                    },
                }, e.C_BLOCK_COMMENT_MODE, e.COMMENT("--", "$")]
            }
        });
    </script>

    <style type="text/css">
        :root {
            --sidebar-width: 275px;
            --header-height: 51px;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        .navbar {
            background-color: #fff;
            border-bottom: 1px solid #cacaca;
            height: var(--header-height);
            padding: 0 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .navbar-text {
            font-weight: bold;
            font-size: 22px;
            margin: 0;
        }

        .main-container {
            height: calc(100% - var(--header-height));
            display: flex;
        }

        .sidebar-wrapper {
            width: var(--sidebar-width);
            background-color: #f5f5f5;
            border-right: 1px solid #cacaca;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-nav {
            padding: 15px;
            flex-shrink: 0;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .input-group {
            position: relative;
            display: flex;
        }

        .input-group-addon {
            padding: 8px 12px;
            background-color: #eee;
            border: 1px solid #ccc;
            border-right: none;
            border-radius: 4px 0 0 4px;
        }

        .input-group input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 0 4px 4px 0;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        select.form-control {
            padding: 6px 12px;
            height: 36px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 14px;
        }

        .checkbox-label input[type="checkbox"] {
            margin: 0 5px 0 0;
        }

        .filterCount {
            color: #cacaca;
            font-size: 13px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-list li {
            margin: 0;
        }

        .nav-list a {
            display: block;
            padding: 8px 15px;
            text-decoration: none;
            color: #333;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }

        .nav-list a:hover {
            background-color: #77BFFD;
            color: #fff;
        }

        .nav-list a.active {
            background-color: #428bca;
            color: #fff;
            border-left-color: #2a6496;
        }

        .nav-list a:hover span,
        .nav-list a.active span {
            color: white;
        }

        .entity-name {
            text-decoration: underline;
            word-wrap: break-word;
        }

        .entity-definition {
            color: #666;
            font-style: italic;
            font-size: 12px;
            margin-top: 3px;
        }

        .nav-list a.active .entity-definition {
            color: #fff;
        }

        .content-wrapper {
            flex: 1;
            overflow-y: auto;
            padding: 20px 40px;
        }

        .page-header {
            font-size: 32px;
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .deprecation-text {
            color: red;
            margin-left: 10px;
        }

        h3 {
            font-size: 20px;
            margin: 20px 0 10px 0;
        }

        .inline-header {
            display: inline-block;
        }

        .table-responsive {
            overflow-x: auto;
            margin: 15px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ddd;
        }

        table th {
            background-color: #f5f5f5;
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
            font-weight: 600;
        }

        table td {
            padding: 10px;
            border: 1px solid #ddd;
        }

        table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        table tr:hover {
            background-color: #f0f0f0;
        }

        a {
            color: #428bca;
            text-decoration: underline;
        }

        a:hover {
            color: #2a6496;
        }

        .highlight-text {
            background-color: yellow;
            font-weight: bold;
        }

        .merge-property {
            color: #569cd6;
            font-weight: bold;
        }

        ul {
            padding-left: 20px;
        }

        pre {
            background-color: #f6f8fa;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
        }

        code {
            font-family: 'Courier New', Courier, monospace;
        }

        .text-ellipsis {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
        }

        /* Multi-select styling */
        select[multiple] {
            height: auto;
            min-height: 80px;
        }
    </style>

    <script type="text/javascript">
        // Data will be injected here by the generator
        const handbookData = {JSONData};

        // Alpine.js application logic
        document.addEventListener('alpine:init', () => {
            Alpine.data('handbookApp', () => ({
                entries: handbookData,
                search: '',
                includeDefinition: false,
                selectedEntityTypes: [],
                selectedDomains: [],
                selectedEntity: null,
                showMerge: false,

                init() {
                    // Select first entry by default
                    if (this.entries && this.entries.length > 0) {
                        this.selectEntity(this.entries[0]);
                    }

                    // Handle URL hash for direct navigation
                    this.handleHashChange();
                    window.addEventListener('hashchange', () => this.handleHashChange());

                    // Highlight code blocks after render
                    this.$nextTick(() => {
                        this.highlightCodeBlocks();
                    });
                },

                handleHashChange() {
                    const hash = window.location.hash.slice(1);
                    if (hash && hash !== '/') {
                        // Remove leading slash if present
                        const entityId = hash.startsWith('/') ? hash.slice(1) : hash;
                        const entity = this.entries.find(e => e.uniqueIdentifier === entityId);
                        if (entity) {
                            this.selectEntity(entity);
                        }
                    }
                },

                get entityFilterTypes() {
                    const types = [...new Set(this.entries.map(e => e.umlType))];
                    return types.sort();
                },

                get domains() {
                    const allDomains = this.entries.flatMap(e => e.domains || []);
                    return [...new Set(allDomains)].sort();
                },

                get filteredEntries() {
                    let filtered = this.entries;

                    // Filter by search
                    if (this.search) {
                        const searchLower = this.search.toLowerCase();
                        filtered = filtered.filter(entry => {
                            const nameMatch = entry.name.toLowerCase().includes(searchLower);
                            const idMatch = entry.metaEdId && entry.metaEdId.toLowerCase().includes(searchLower);
                            const defMatch = this.includeDefinition && entry.definition &&
                                entry.definition.toLowerCase().includes(searchLower);
                            return nameMatch || idMatch || defMatch;
                        });
                    }

                    // Filter by entity types
                    if (this.selectedEntityTypes.length > 0) {
                        filtered = filtered.filter(entry =>
                            this.selectedEntityTypes.includes(entry.umlType)
                        );
                    }

                    // Filter by domains
                    if (this.selectedDomains.length > 0) {
                        filtered = filtered.filter(entry =>
                            entry.domains && entry.domains.some(d => this.selectedDomains.includes(d))
                        );
                    }

                    return filtered.sort((a, b) => a.name.localeCompare(b.name));
                },

                selectEntity(entity) {
                    this.selectedEntity = entity;
                    window.location.hash = `/${entity.uniqueIdentifier}`;

                    // Check if merge should be shown
                    this.showMerge = entity.modelReferencesContainsProperties &&
                        entity.modelReferencesContainsProperties.some(prop =>
                            prop.mergeDirectives && prop.mergeDirectives.length > 0
                        );

                    // Highlight code after render
                    this.$nextTick(() => {
                        this.highlightCodeBlocks();
                    });
                },

                navigateToEntity(uniqueIdentifier, shouldResetSearch) {
                    const entity = this.entries.find(e => e.uniqueIdentifier === uniqueIdentifier);
                    if (entity) {
                        if (shouldResetSearch === true) {
                            this.resetSearch();
                        }
                        this.selectEntity(entity);
                    }
                },

                resetSearch() {
                    this.search = '';
                    this.selectedEntityTypes = [];
                    this.selectedDomains = [];
                },

                entityExists(uniqueIdentifier) {
                    return this.entries.some(e => e.uniqueIdentifier === uniqueIdentifier);
                },

                highlightText(text, phrase) {
                    if (!phrase || !text) return text;
                    const regex = new RegExp(`(${phrase})`, 'gi');
                    return text.replace(regex, '<span class="highlight-text">$1</span>');
                },

                boldText(text, phrase) {
                    if (!phrase || !text) return text;
                    const regex = new RegExp(`(${phrase})`, 'gi');
                    return text.replace(regex, '<b>$1</b>');
                },

                displaySideDefinition(definition) {
                    if (!definition) return '';
                    const searchLower = this.search.toLowerCase();
                    const indexOf = definition.toLowerCase().indexOf(searchLower);
                    const paddingLength = Math.max(0, Math.min(7, 30 - this.search.length));

                    if (indexOf < 10 || definition.length < 30) {
                        return definition;
                    } else {
                        if (definition.length - indexOf < 30) {
                            return '...' + definition.substring(definition.length - 30);
                        } else {
                            return '...' + definition.substring(indexOf - paddingLength);
                        }
                    }
                },

                trueFalseToYesNo(value) {
                    return value ? 'Yes' : 'No';
                },

                getMergeStyle(merge, isLast) {
                    return isLast ? {} : { 'padding-bottom': '10px' };
                },

                isActiveEntity(entity) {
                    return this.selectedEntity &&
                        this.selectedEntity.uniqueIdentifier === entity.uniqueIdentifier;
                },

                highlightCodeBlocks() {
                    document.querySelectorAll('pre code').forEach((block) => {
                        // Remove previous highlighting if it exists
                        if (block.dataset.highlighted) {
                            delete block.dataset.highlighted;
                        }
                        hljs.highlightElement(block);
                    });
                }
            }));
        });
    </script>

</head>

<body x-data="handbookApp" style="overflow-y: hidden">
    <nav class="navbar">
        <span class="navbar-text">Ed-Fi Unified Data Model Handbook</span>
    </nav>

    <div class="main-container">
        <div class="sidebar-wrapper">
            <div class="sidebar-nav">
                <div class="form-group">
                    <div class="input-group">
                        <div class="input-group-addon">
                            <i class="fa fa-search"></i>
                        </div>
                        <input type="text" class="form-control" placeholder="Search by name" x-model="search">
                    </div>
                </div>
                <div>
                    <label class="checkbox-label">
                        <input type="checkbox" x-model="includeDefinition" /> Include Definition in Search
                    </label>
                </div>
                <div class="form-group">
                    <select class="form-control" x-model="selectedEntityTypes" multiple aria-label="Filter by UML Type"
                        aria-describedby="uml-type-help">
                        <template x-for="(type, index) in entityFilterTypes" :key="`type-${index}-${type}`">
                            <option :value="type" x-text="type"></option>
                        </template>
                    </select>
                    <small id="uml-type-help" style="display: block; margin-top: 3px; color: #666;">Filter by UML Type
                        (hold Ctrl/Cmd to select multiple)</small>
                </div>
                <div class="form-group">
                    <select class="form-control" x-model="selectedDomains" multiple aria-label="Filter by Domain"
                        aria-describedby="domain-help">
                        <template x-for="(domain, index) in domains" :key="`domain-${index}-${domain}`">
                            <option :value="domain" x-text="domain"></option>
                        </template>
                    </select>
                    <small id="domain-help" style="display: block; margin-top: 3px; color: #666;">Filter by Domain (hold
                        Ctrl/Cmd to select multiple)</small>
                </div>
                <span class="filterCount" x-text="`[Displaying ${filteredEntries.length} of ${entries.length}]`"></span>
            </div>
            <div class="sidebar-content">
                <ul class="nav-list">
                    <template x-for="(entry, index) in filteredEntries"
                        :key="`entry-${index}-${entry.uniqueIdentifier}`">
                        <li>
                            <a href="#" @click.prevent="selectEntity(entry)"
                                :class="{ 'active': isActiveEntity(entry) }"
                                :title="`${entry.metaEdId || ''} - ${entry.name}`">
                                <span class="entity-name" x-html="boldText(entry.name, search)"></span>
                                <template x-if="includeDefinition && search && entry.definition">
                                    <span class="entity-definition" :title="entry.definition"
                                        x-html="boldText(displaySideDefinition(entry.definition), search)"></span>
                                </template>
                            </a>
                        </li>
                    </template>
                </ul>
            </div>
        </div>
        <div class="content-wrapper" x-show="selectedEntity">
            <template x-if="selectedEntity">
                <div>
                    <h1 class="page-header">
                        <span x-text="selectedEntity.name"></span>
                        <template x-if="selectedEntity.deprecationText">
                            <span class="deprecation-text" x-text="selectedEntity.deprecationText"></span>
                        </template>
                    </h1>
                    <h3 class="inline-header">
                        UML Type: <span x-text="selectedEntity.umlType"></span>
                        <template x-if="selectedEntity.baseMetaEdType">
                            <span>
                                extending
                                <a href="#"
                                    @click.prevent="navigateToEntity(selectedEntity.baseEntityUniqueIdentifier, true)"
                                    :title="selectedEntity.baseMetaEdType" x-text="selectedEntity.baseMetaEdType"></a>
                            </span>
                        </template>
                    </h3>
                    <h3>MetaEd Metadata</h3>
                    <p>MetaEd Entity Type: <span x-text="selectedEntity.metaEdType"></span></p>
                    <template x-if="selectedEntity.metaEdId">
                        <p>MetaEd ID: <span x-text="selectedEntity.metaEdId"></span></p>
                    </template>
                    <h3>Definition</h3>
                    <p x-html="highlightText(selectedEntity.definition || '', search)"></p>
                    <template x-if="selectedEntity.deprecationReason">
                        <div>
                            <h3>Deprecation Reason</h3>
                            <p x-text="selectedEntity.deprecationReason"></p>
                        </div>
                    </template>
                    <template x-if="selectedEntity.typeCharacteristics && selectedEntity.typeCharacteristics.length">
                        <div>
                            <h3>Type Characteristics:</h3>
                            <ul>
                                <template x-for="(characteristic, index) in selectedEntity.typeCharacteristics"
                                    :key="`char-${index}-${characteristic}`">
                                    <li x-text="characteristic"></li>
                                </template>
                            </ul>
                        </div>
                    </template>
                    <template x-if="selectedEntity.optionList && selectedEntity.optionList.length">
                        <div>
                            <h3>Option List</h3>
                            <ul>
                                <template x-for="(option, index) in selectedEntity.optionList"
                                    :key="`option-${index}-${option}`">
                                    <li x-text="option"></li>
                                </template>
                            </ul>
                        </div>
                    </template>
                    <template
                        x-if="selectedEntity.modelReferencesContains && selectedEntity.modelReferencesContains.length > 0">
                        <div>
                            <h3>References</h3>
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Property</th>
                                            <template x-if="selectedEntity.hasDeprecatedProperty">
                                                <th>Deprecation Reason</th>
                                            </template>
                                            <th>UML Datatype</th>
                                            <th>JSON Datatype</th>
                                            <th>JSON Element Name</th>
                                            <th>Other</th>
                                            <template x-if="selectedEntity.showIdentityColumn">
                                                <th>Identity</th>
                                            </template>
                                            <th>Is Sensitive Data</th>
                                            <th>Cardinality</th>
                                            <th>Definition</th>
                                            <template x-if="showMerge">
                                                <th>Merge</th>
                                            </template>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="prop in selectedEntity.modelReferencesContainsProperties"
                                            :key="`prop-${prop.name}-${prop.metaEdId || ''}`">
                                            <tr>
                                                <td>
                                                    <template x-if="entityExists(prop.referenceUniqueIdentifier)">
                                                        <a href="#"
                                                            @click.prevent="navigateToEntity(prop.referenceUniqueIdentifier, true)"
                                                            :title="`${prop.metaEdId || ''} - ${prop.name}`"
                                                            x-text="prop.name"></a>
                                                    </template>
                                                    <template x-if="!entityExists(prop.referenceUniqueIdentifier)">
                                                        <span :title="`${prop.metaEdId || ''} - ${prop.name}`"
                                                            x-text="prop.name"></span>
                                                    </template>
                                                    <template x-if="prop.extensionParentNamespaceName">
                                                        <span
                                                            x-text="` (from ${prop.extensionParentNamespaceName})`"></span>
                                                    </template>
                                                    <template x-if="prop.deprecationText">
                                                        <span class="deprecation-text"
                                                            x-text="` - ${prop.deprecationText}`"></span>
                                                    </template>
                                                </td>
                                                <template x-if="selectedEntity.hasDeprecatedProperty">
                                                    <td x-text="prop.deprecationReason || ''"></td>
                                                </template>
                                                <td x-text="prop.umlDatatype"></td>
                                                <td x-text="prop.jsonDatatype"></td>
                                                <td x-text="prop.jsonElementName"></td>
                                                <td>
                                                    <p>MetaEd DSL Datatype: <span x-text="prop.metaEdDatatype"></span>
                                                    </p>
                                                    <template x-if="prop.sqlDatatype">
                                                        <p>SQL Recommended Datatype: <span
                                                                x-text="prop.sqlDatatype"></span></p>
                                                    </template>
                                                    <template x-if="!selectedEntity.showIdentityColumn">
                                                        <p>Ed-Fi ODS/API Identity: <span
                                                                x-text="trueFalseToYesNo(prop.isOdsApiIdentity)"></span>
                                                        </p>
                                                    </template>
                                                </td>
                                                <template x-if="selectedEntity.showIdentityColumn">
                                                    <td x-text="trueFalseToYesNo(prop.isIdentity)"></td>
                                                </template>
                                                <td x-text="trueFalseToYesNo(prop.isSensitiveData)"></td>
                                                <td x-text="prop.cardinality"></td>
                                                <td x-text="prop.definition"></td>
                                                <template x-if="showMerge">
                                                    <td>
                                                        <template
                                                            x-if="prop.mergeDirectives && prop.mergeDirectives.length">
                                                            <template x-for="(merge, index) in prop.mergeDirectives"
                                                                :key="`merge-${index}`">
                                                                <div
                                                                    :style="getMergeStyle(merge, index === prop.mergeDirectives.length - 1)">
                                                                    <template
                                                                        x-for="(path, pathIndex) in merge.propertyPath"
                                                                        :key="`proppath-${index}-${pathIndex}`">
                                                                        <span>
                                                                            <span x-text="path"></span>
                                                                            <template
                                                                                x-if="pathIndex < merge.propertyPath.length - 1">
                                                                                <span>.</span>
                                                                            </template>
                                                                        </span>
                                                                    </template>
                                                                    with
                                                                    <template
                                                                        x-for="(path, pathIndex) in merge.targetPath"
                                                                        :key="`targetpath-${index}-${pathIndex}`">
                                                                        <span>
                                                                            <span x-text="path"></span>
                                                                            <template
                                                                                x-if="pathIndex < merge.targetPath.length - 1">
                                                                                <span>.</span>
                                                                            </template>
                                                                        </span>
                                                                    </template>
                                                                </div>
                                                            </template>
                                                        </template>
                                                    </td>
                                                </template>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </template>
                    <template
                        x-if="selectedEntity.modelReferencesUsedByProperties && selectedEntity.modelReferencesUsedByProperties.length">
                        <div>
                            <h3>Used By</h3>
                            <ul>
                                <template x-for="(usedBy, index) in selectedEntity.modelReferencesUsedByProperties"
                                    :key="`usedby-${index}-${usedBy.entityName}-${usedBy.propertyName}`">
                                    <li>
                                        <a href="#" @click.prevent="navigateToEntity(usedBy.referenceUniqueIdentifier)"
                                            :title="`${usedBy.entityName} - ${usedBy.propertyName}`"
                                            x-text="usedBy.entityName"></a>
                                        .<span x-text="usedBy.propertyName"></span> (as <span
                                            x-text="usedBy.cardinality"></span>)
                                    </li>
                                </template>
                            </ul>
                        </div>
                    </template>
                    <template x-if="selectedEntity.domains && selectedEntity.domains.length">
                        <div>
                            <h3>Domains</h3>
                            <ul>
                                <template x-for="(domain, index) in selectedEntity.domains"
                                    :key="`dom-${index}-${domain}`">
                                    <li x-text="domain"></li>
                                </template>
                            </ul>
                        </div>
                    </template>
                    <template x-if="selectedEntity.xsdFragment && selectedEntity.xsdFragment.length">
                        <div>
                            <h3>XSD</h3>
                            <pre><code class="language-xml" x-text="selectedEntity.xsdFragment"></code></pre>
                        </div>
                    </template>
                    <template x-if="selectedEntity.odsFragment && selectedEntity.odsFragment.length">
                        <div>
                            <h3>SQL Server Snippet</h3>
                            <template x-for="(fragment, index) in selectedEntity.odsFragment" :key="`ods-${index}`">
                                <pre><code class="language-edfisql" x-text="fragment"></code></pre>
                            </template>
                        </div>
                    </template>
                </div>
            </template>
        </div>
    </div>
</body>

</html>