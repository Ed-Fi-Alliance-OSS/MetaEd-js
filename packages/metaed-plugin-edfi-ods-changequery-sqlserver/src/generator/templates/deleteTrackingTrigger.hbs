{{#if useLicenseHeader}}
{{#if triggers}}
-- SPDX-License-Identifier: Apache-2.0
-- Licensed to the Ed-Fi Alliance under one or more agreements.
-- The Ed-Fi Alliance licenses this file to you under the Apache License, Version 2.0.
-- See the LICENSE and NOTICES files in the project root for more information.

{{/if}}
{{/if}}
{{#triggers}}
CREATE TRIGGER [{{{triggerSchema}}}].[{{{triggerName}}}] ON [{{{targetTableSchema}}}].[{{{targetTableName}}}] AFTER DELETE AS
BEGIN
    IF @@rowcount = 0 
        RETURN

    SET NOCOUNT ON

    INSERT INTO [{{{deleteTrackingTableSchema}}}].[{{{deleteTrackingTableName}}}]({{#primaryKeyColumnNames}}{{{this}}}{{#unless @last}}, {{/unless}}{{/primaryKeyColumnNames}}, Id, ChangeVersion)
    SELECT  {{#primaryKeyColumnNames}}{{#if ../targetTableIsSubclass}}d.{{/if}}{{{this}}}{{#unless @last}}, {{/unless}}{{/primaryKeyColumnNames}}, Id, (NEXT VALUE FOR [changes].[ChangeVersionSequence])
    FROM    deleted d{{#if targetTableIsSubclass}}{{#foreignKeyToSuperclass}}
            INNER JOIN {{{foreignTableSchema}}}.{{{foreignTable.data.edfiOdsSqlServer.tableName}}} b ON {{#data.edfiOdsChangeQuery.columnNames}}d.{{{parentTableColumnName}}} = b.{{{foreignTableColumnName}}}{{#unless @last}} AND {{/unless}}{{/data.edfiOdsChangeQuery.columnNames}}{{/foreignKeyToSuperclass}}{{/if}}
END
GO

ALTER TABLE [{{{targetTableSchema}}}].[{{{targetTableName}}}] ENABLE TRIGGER [{{{triggerName}}}]
GO


{{/triggers}}